{% extends "base.html" %}

{% block title %}Executando cen√°rio{% endblock %}

{% block content %}
  <section>
    <h2>{{ scenario.title }}</h2>
    <p>{{ scenario.description }}</p>
  </section>

  <section class="scenario-screens">
    <div id="scenario-screen-container"
         data-current-index="0">
      {% if screens %}
        {% with screen = screens[0] %}
          {% include "scenario_runs/partials/screen.html" %}
        {% endwith %}
      {% else %}
        <p>Este cen√°rio ainda n√£o possui telas l√∫dicas configuradas.</p>
      {% endif %}
    </div>

    {% if screens|length > 1 %}
      <div class="screen-nav">
        <button type="button" id="btn-prev-screen">Anterior</button>
        <span id="screen-indicator">Tela 1 de {{ screens|length }}</span>
        <button type="button" id="btn-next-screen">Pr√≥xima</button>
      </div>
    {% endif %}
  </section>

  <div class="run-layout">
    <!-- COLUNA ESQUERDA -->
    <section class="run-column-left">
      <h3>Ferramentas e reagentes</h3>

      <h4>Instrumentos</h4>
      <div class="tools-grid">
        {% for inst in transfer_instruments %}
          <button type="button"
                  class="tool-card"
                  data-tool-type="instrument"
                  data-tool-id="{{ inst.id }}">
            {% if inst.image_path %}
              <img src="/assets/images/{{ inst.image_path }}" alt="{{ inst.name }}" class="tool-image" />
            {% endif %}
            <strong>{{ inst.name }}</strong><br />
          </button>
        {% endfor %}
      </div>

      <h4 style="margin-top: 1rem;">Reagentes</h4>
      <div class="tools-grid">
        {% for reagent in reagents %}
          <button type="button"
                  class="tool-card"
                  data-tool-type="reagent"
                  data-tool-id="{{ reagent.id }}">
            {% if reagent.image_path %}
              <img src="/assets/images/{{ reagent.image_path }}" alt="{{ reagent.name }}" class="tool-image" />
            {% endif %}
            <strong>{{ reagent.name }}</strong>
          </button>
        {% endfor %}
      </div>
    </section>

    <!-- COLUNA CENTRAL -->
    <section class="run-column-center">
      <h3>Painel de a√ß√£o</h3>

      <p id="action-panel-hint" class="action-panel-hint">
        Selecione um reagente na coluna √† esquerda para iniciar uma a√ß√£o.
      </p>

      <form
        id="action-form"
        class="action-panel-wrapper hidden"
        hx-post="/ui/scenario-runs/{{ run_state.run_id }}/actions"
        hx-target="#run-state"
        hx-swap="innerHTML">

        <div class="action-panel">

          <!-- Tipo de a√ß√£o -->
          <div class="action-panel-section">
            <label for="action_type" class="action-panel-label">Tipo de a√ß√£o</label>
            <select name="action_type" id="action_type" class="action-panel-select">
              <option value="transfer_solid_with_spatula">Transferir s√≥lido com esp√°tula</option>
              <option value="transfer_liquid_with_pipette">Transferir l√≠quido com pipeta</option>
              <option value="pour_liquid_between_containers">Despejar entre recipientes</option>
            </select>
          </div>

          <!-- Instrumento e Reagente -->
          <div class="action-panel-inline">
            <div class="action-panel-section">
              <label class="action-panel-label">Instrumento</label>
              <div id="selected-instrument-label" class="action-panel-pill">
                <span class="icon-placeholder">‚öôÔ∏è</span>
                Selecione
              </div>
              <input type="hidden" name="instrument_id" id="instrument_id" />
            </div>

            <div class="action-panel-section">
              <label class="action-panel-label">Reagente</label>
              <div id="selected-reagent-label" class="action-panel-pill">
                <span class="icon-placeholder">üß™</span>
                Selecione
              </div>
              <input type="hidden" name="reagent_id" id="reagent_id" />
            </div>
          </div>

          <!-- Origem e Destino em cards lado a lado -->
          <div class="action-panel-containers">
            <div class="action-panel-container-card origin-card">
              <div class="action-panel-card-label">Origem</div>
              <div class="action-panel-card-icon">üì¶</div>
              <select name="source_container_name" id="source_container_name" class="action-panel-container-select">
                <option value="">Sem recipiente de origem (estoque)</option>
                {% for name in container_names %}
                  {% set meta = containers_meta[name] %}
                  {% set label = instrument_map.get(meta.instrument_id, name) %}
                  <option value="{{ name }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="action-panel-arrow">‚Üí</div>

            <div class="action-panel-container-card destination-card">
              <div class="action-panel-card-label">Destino</div>
              <div class="action-panel-card-icon">üì¶</div>
              <select name="target_container_name" id="target_container_name" class="action-panel-container-select">
                <option value="">(Selecione)</option>
                {% for name in container_names %}
                  {% set meta = containers_meta[name] %}
                  {% set label = instrument_map.get(meta.instrument_id, name) %}
                  <option value="{{ name }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Quantidade e Unidade -->
          <div class="action-panel-quantity">
            <div class="action-panel-section">
              <label for="amount_value" class="action-panel-label">Quantidade</label>
              <input type="number" step="0.1" name="amount_value" id="amount_value" class="action-panel-input" placeholder="0.0" />
            </div>

            <div class="action-panel-section">
              <label for="amount_unit" class="action-panel-label">Unidade</label>
              <select name="amount_unit" id="amount_unit" class="action-panel-select">
                <option value="">(Selecione)</option>
                <option value="g">g</option>
                <option value="mL">mL</option>
                <option value="drop">gotas</option>
              </select>
            </div>
          </div>

          <!-- Bot√£o de a√ß√£o -->
          <div class="action-panel-submit">
            <button type="submit" class="action-panel-button">Adicionar</button>
          </div>
        </div>
      </form>

      <section id="run-state"
               class="run-state"
               hx-get="/ui/scenario-runs/{{ run_state.run_id }}/state"
               hx-trigger="load"
               hx-target="#run-state"
               hx-swap="innerHTML">
        Carregando estado da simula√ß√£o...
      </section>
    </section>

    <!-- COLUNA DIREITA -->
    <section class="run-column-right" id="scenario-steps">
      <!-- Conte√∫do preenchido via hx-swap-oob -->
    </section>
  </div>

  <script id="screens-data" type="application/json">
    {{ screens_json | safe }}
  </script>

  <!-- Script para ligar cards ao painel de a√ß√£o -->
  <script>
    (function () {
      const toolCards = document.querySelectorAll(".tool-card");
      const instrumentInput = document.getElementById("instrument_id");
      const reagentInput = document.getElementById("reagent_id");
      const instrumentLabel = document.getElementById("selected-instrument-label");
      const reagentLabel = document.getElementById("selected-reagent-label");
      const actionPanel = document.getElementById("action-form");
      const actionHint = document.getElementById("action-panel-hint");
      const actionTypeSelect = document.getElementById("action_type");

      function clearSelected(type) {
        document.querySelectorAll('.tool-card[data-tool-type="' + type + '"]')
          .forEach(function (card) {
            card.classList.remove("selected");
          });
      }

      function openActionPanelIfNeeded() {
        if (!actionPanel) return;
        const actionType = actionTypeSelect ? actionTypeSelect.value : "";
        if (actionType === "pour_liquid_between_containers") {
          actionPanel.classList.remove("hidden");
          if (actionHint) {
            actionHint.style.display = "none";
          }
        }
      }

      toolCards.forEach(function (card) {
        card.addEventListener("click", function () {
          const type = card.dataset.toolType;
          const id = card.dataset.toolId;
          const name = card.querySelector("strong")?.textContent || "";

          if (type === "instrument") {
            const wasSelected = card.classList.contains("selected");
            clearSelected("instrument");

            if (wasSelected) {
              card.classList.remove("selected");
              if (instrumentInput) instrumentInput.value = "";
              if (instrumentLabel) instrumentLabel.innerHTML = '<span class="icon-placeholder">‚öôÔ∏è</span>Selecione';
            } else {
              card.classList.add("selected");
              if (instrumentInput) instrumentInput.value = id;
              if (instrumentLabel) instrumentLabel.innerHTML = '<span class="icon-placeholder">‚öôÔ∏è</span>' + name;
            }
          }

          if (type === "reagent") {
            const wasSelected = card.classList.contains("selected");
            clearSelected("reagent");

            if (wasSelected) {
              card.classList.remove("selected");
              if (reagentInput) reagentInput.value = "";
              if (reagentLabel) reagentLabel.innerHTML = '<span class="icon-placeholder">üß™</span>Selecione';
              return;
            }

            card.classList.add("selected");
            if (reagentInput) reagentInput.value = id;
            if (reagentLabel) reagentLabel.innerHTML = '<span class="icon-placeholder">üß™</span>' + name;

            if (actionPanel && actionPanel.classList.contains("hidden")) {
              actionPanel.classList.remove("hidden");
            }
            if (actionHint) {
              actionHint.style.display = "none";
            }
          }
        });
      });

      if (actionTypeSelect) {
        actionTypeSelect.addEventListener("change", function () {
          openActionPanelIfNeeded();
        });
      }

      openActionPanelIfNeeded();
    })();
  </script>

  <script>
    (function () {
      const screenContainer = document.getElementById("scenario-screen-container");
      const screensDataScript = document.getElementById("screens-data");
      const btnPrev = document.getElementById("btn-prev-screen");
      const btnNext = document.getElementById("btn-next-screen");
      const indicator = document.getElementById("screen-indicator");
      const scenarioId = {{ scenario.id }};
      let screens = [];

      try {
        screens = JSON.parse(screensDataScript?.textContent || "[]");
      } catch (err) {
        screens = [];
      }

      function updateIndicator(currentIndex) {
        if (!indicator) return;
        indicator.textContent = `Tela ${currentIndex + 1} de ${screens.length}`;
      }

      function updateNavButtons(currentIndex) {
        if (btnPrev) btnPrev.disabled = currentIndex <= 0;
        if (btnNext) btnNext.disabled = currentIndex >= screens.length - 1;
      }

      function setupGifButton(screenElement) {
        const playButton = screenElement.querySelector(".screen-play-btn");
        const gifImage = screenElement.querySelector(".screen-gif");
        if (!playButton || !gifImage) return;

        playButton.addEventListener("click", function () {
          const gifPath = gifImage.dataset.gifPath;
          if (gifPath) {
            gifImage.src = `/assets/images/${gifPath}?t=${Date.now()}`;
          }
        });
      }

      function setupSlider(screenElement, screenData) {
        if (!screenElement || screenData?.screen_type !== "title_image_slider") return;
        const images = screenData.slider_images || [];
        const imgEl = screenElement.querySelector(".screen-slider-image");
        const captionEl = screenElement.querySelector(".screen-slider-caption");
        const prevBtn = screenElement.querySelector(".slider-prev");
        const nextBtn = screenElement.querySelector(".slider-next");
        let idx = 0;

        function render() {
          if (!images.length || !imgEl) return;
          const current = images[idx];
          imgEl.src = `/assets/images/${current.image_path}`;
          imgEl.alt = current.caption || screenData.title || "Slide";
          if (captionEl) {
            if (current.caption) {
              captionEl.textContent = current.caption;
              captionEl.style.display = "";
            } else {
              captionEl.textContent = "";
              captionEl.style.display = "none";
            }
          }
          if (prevBtn) prevBtn.disabled = idx === 0;
          if (nextBtn) nextBtn.disabled = idx >= images.length - 1;
        }

        if (prevBtn) {
          prevBtn.addEventListener("click", function () {
            if (idx > 0) {
              idx -= 1;
              render();
            }
          });
        }
        if (nextBtn) {
          nextBtn.addEventListener("click", function () {
            if (idx < images.length - 1) {
              idx += 1;
              render();
            }
          });
        }

        render();
      }

      function attachScreenBehaviors(screenElement, screenData) {
        setupGifButton(screenElement);
        setupSlider(screenElement, screenData);
      }

      async function loadScreen(index) {
        if (!screenContainer || !screens.length || index < 0 || index >= screens.length) {
          return;
        }

        const currentScreenElement = screenContainer.querySelector(".scenario-screen");

        try {
          const response = await fetch(`/ui/scenarios/${scenarioId}/screens/${index}`);
          if (!response.ok) {
            return;
          }
          const html = await response.text();
          const temp = document.createElement("div");
          temp.innerHTML = html.trim();
          const nextElement = temp.firstElementChild;
          if (!nextElement) return;

          screenContainer.appendChild(nextElement);
          attachScreenBehaviors(nextElement, screens[index]);
          screenContainer.dataset.currentIndex = String(index);
          updateIndicator(index);
          updateNavButtons(index);

          const animationKey = screens[index]?.animation_key || "";
          if (window.labAnimations) {
            window.labAnimations.applyScreenAnimation(
              currentScreenElement,
              nextElement,
              animationKey
            );
          } else {
            if (currentScreenElement && currentScreenElement !== nextElement) {
              currentScreenElement.remove();
            }
          }
        } catch (err) {
          console.error("Erro ao carregar tela do cen√°rio", err);
        }
      }

      if (screenContainer && screens.length) {
        const initialScreen = screenContainer.querySelector(".scenario-screen");
        attachScreenBehaviors(initialScreen, screens[0]);
        updateIndicator(0);
        updateNavButtons(0);
      }

      if (btnPrev) {
        btnPrev.addEventListener("click", function () {
          const currentIndex = Number(screenContainer?.dataset.currentIndex || 0);
          const targetIndex = currentIndex - 1;
          loadScreen(targetIndex);
        });
      }

      if (btnNext) {
        btnNext.addEventListener("click", function () {
          const currentIndex = Number(screenContainer?.dataset.currentIndex || 0);
          const targetIndex = currentIndex + 1;
          loadScreen(targetIndex);
        });
      }
    })();
  </script>
{% endblock %}
