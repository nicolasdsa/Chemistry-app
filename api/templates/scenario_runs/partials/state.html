<section class="run-state">
  <h3>Estado da simulação</h3>
  {% if error_message %}
    <div class="alert alert-error">
      {{ error_message }}
    </div>
  {% elif run_state.message %}
    <div class="alert alert-success">
      {{ run_state.message }}
    </div>
  {% endif %}

  <div class="viz-grid">
    <div class="playground">
      {% for name, contents in run_state.containers.items() %}
        {% set meta = run_state.containers_meta[name] %}
        {% if meta.is_container %}
          {% set instrument_name = instrument_map.get(meta.instrument_id, name) %}
          {% set total = 0 %}
          {% for item in contents %}
            {% set total = total + (item.amount_value or 0) %}
          {% endfor %}
          {% set foam_level = "none" %}
          {% if total > 80 %}
            {% set foam_level = "high" %}
          {% elif total > 40 %}
            {% set foam_level = "medium" %}
          {% elif total > 0 %}
            {% set foam_level = "low" %}
          {% endif %}
          <div class="beaker" data-container="{{ name }}">
            <div class="beaker-label">{{ instrument_name }}</div>
            <div class="beaker-body">
              <div class="foam foam-level-{{ foam_level }}"
                   style="height: {{ [total, 100]|min }}%;"></div>
            </div>
            <div class="beaker-volume">Volume: {{ "%.1f"|format(total) }} u</div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="containers">
      {% for name, contents in run_state.containers.items() %}
        {% set meta = run_state.containers_meta[name] %}
        {% if meta.is_container %}
          {% set instrument_name = instrument_map.get(meta.instrument_id, name) %}
          {% set total = 0 %}
          {% for item in contents %}
            {% set total = total + (item.amount_value or 0) %}
          {% endfor %}
          <div class="container-card">
            <h4>Recipiente {{ instrument_name }}</h4>
            <p class="container-meta">
              Volume estimado: {{ "%.1f"|format(total) }} u
              <span class="pill pill-{{ 'high' if total > 80 else 'medium' if total > 40 else 'low' if total > 0 else 'none' }}">
                espuma {{ 'alta' if total > 80 else 'média' if total > 40 else 'baixa' if total > 0 else 'nenhuma' }}
              </span>
            </p>
            {% if contents %}
              <ul>
                {% for item in contents %}
                  {% set reagent_name = reagents_map.get(item.reagent_id, "Reagente " ~ item.reagent_id) %}
                  <li>{{ reagent_name }} — {{ item.amount_value }} {{ item.amount_unit }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <p>Vazio.</p>
            {% endif %}
          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</section>

<section id="scenario-steps"
         class="run-column-right"
         hx-swap-oob="innerHTML">
  <h3>Instruções do cenário</h3>

  <div class="steps-panel">
    {% if scenario and scenario.steps %}
      {% for step in scenario.steps %}
        <div class="step-item {% if loop.index0 == run_state.current_step_index %}step-item-current{% endif %}">
          <strong>Passo {{ loop.index }}:</strong><br />
          {{ step.text_instruction }}
        </div>
      {% endfor %}
    {% else %}
      <p>Este cenário ainda não possui passos cadastrados.</p>
    {% endif %}
  </div>
</section>

{% set completed_index = run_state.current_step_index - 1 %}
{% if completed_index >= 0 and scenario and completed_index < scenario.steps|length %}
  {% set completed_step = scenario.steps[completed_index] %}
  {% if completed_step.sound_effect_path %}
    <script hx-swap-oob="true">
      (function() {
        var audio = new Audio("/assets/audio/{{ completed_step.sound_effect_path }}");
        audio.play();
      })();
    </script>
  {% endif %}
{% endif %}
